@{
    ViewData["Title"] = "Checkout";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>@ViewData["Title"]</title>
    <link rel="icon" type="image/x-icon" href="~/img/icon.png" />
    <link rel="stylesheet" href="~/css/checkout.css" />
</head>

<body>
    <div class="checkout-container">
        <!-- Left Side: Checkout Form -->
        <div class="checkout-form-section">
            <h1 class="checkout-title">Checkout</h1>
            
            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step active">
                    <div class="step-number">1</div>
                    <span class="step-label">Personal Info</span>
                </div>
                <div class="step-line"></div>
                <div class="step">
                    <div class="step-number">2</div>
                    <span class="step-label">Payment</span>
                </div>
                <div class="step-line"></div>
                <div class="step">
                    <div class="step-number">3</div>
                    <span class="step-label">Confirmation</span>
                </div>
            </div>

            <!-- Form Container (will be swapped) -->
            <div id="formContainer">
                <!-- Personal Info Form -->
                <div class="form-section active" id="personalInfoForm">
                    <h2 class="section-title">Personal Info</h2>
                    
                    <div class="form-group">
                        <label for="fullName">Full Name</label>
                        <input type="text" id="fullName" name="fullName" placeholder="Enter your full name" required />
                    </div>

                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" placeholder="your.email@example.com" required />
                    </div>

                    <div class="form-group">
                        <label for="streetAddress">Street Address</label>
                        <input type="text" id="streetAddress" name="streetAddress" placeholder="123 Main Street" required />
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="state">State/Province</label>
                            <input type="text" id="state" name="state" placeholder="Cavite" required />
                        </div>
                        <div class="form-group">
                            <label for="city">City</label>
                            <input type="text" id="city" name="city" placeholder="Bacoor" required />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="zipCode">Zip/Postal Code</label>
                            <input type="text" id="zipCode" name="zipCode" placeholder="4102" required />
                        </div>
                        <div class="form-group">
                            <label for="phoneNumber">Phone Number</label>
                            <input type="tel" id="phoneNumber" name="phoneNumber" placeholder="+63 912 345 6789" required />
                        </div>
                    </div>
                </div>

                <!-- Payment Form (Initially Hidden) -->
                <div class="form-section" id="paymentForm">
                    <h2 class="section-title">Payment Method</h2>
                    
                    <div class="payment-methods">
                        <label class="payment-option">
                            <input type="radio" name="paymentMethod" value="cod" checked />
                            <div class="payment-card">
                                <div class="payment-icon">ðŸ’µ</div>
                                <div class="payment-info">
                                    <h3>Cash on Delivery</h3>
                                    <p>Pay when you receive your order</p>
                                </div>
                            </div>
                        </label>

                        <label class="payment-option">
                            <input type="radio" name="paymentMethod" value="gcash" />
                            <div class="payment-card">
                                <div class="payment-icon"><img src="../img/gLogo.svg" alt="GCash"></div>
                                <div class="payment-info">
                                    <h3>GCash</h3>
                                    <p>Pay via GCash mobile wallet</p>
                                </div>
                            </div>
                        </label>

                        <label class="payment-option">
                            <input type="radio" name="paymentMethod" value="maya" />
                            <div class="payment-card">
                                <div class="payment-icon"><img src="../img/mayaLogo.png" alt="Maya"></div>
                                <div class="payment-info">
                                    <h3>Maya</h3>
                                    <p>Pay securely with Maya</p>
                                </div>
                            </div>
                        </label>
                    </div>

                    <div class="form-group" style="margin-top: 30px;">
                        <label for="deliveryNotes">Delivery Notes (Optional)</label>
                        <textarea id="deliveryNotes" name="deliveryNotes" rows="4" placeholder="Add any special instructions for your delivery..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="form-navigation">
                <button class="btn-back" id="backBtn" onclick="goBack()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                        <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    Back
                </button>
                    <button class="btn-next" id="nextBtn" onclick="goNext()">
                    Next
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                        <path d="M9 6L15 12L9 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Right Side: Order Summary (Persistent) -->
        <div class="order-summary-section">
            <div class="order-summary-header">
                <h2>Basket</h2>
            </div>

            <!-- Cart Items -->
            <div class="cart-items-list" id="checkoutCartItems">
                
            </div>

            <!-- Order Summary -->
            <div class="order-totals">
                <div class="total-row">
                    <span>Basket Price</span>
                    <span id="basketPrice">â‚±0</span>
                </div>
                <div class="total-row">
                    <span>Delivery</span>
                    <span id="deliveryFee">â‚±50</span>
                </div>
                <div class="total-row grand-total">
                    <span>Order Total</span>
                    <span id="orderTotal">â‚±0</span>
                </div>
            </div>
        </div>
    </div>

    
<script>
// UPDATED CHECKOUT.CSHTML SCRIPT SECTION
// Replace your existing script with this:

document.addEventListener('DOMContentLoaded', function () {
    console.log('Checkout page loaded');

    // -------------------------------
    // Load Cart Items from localStorage
    // -------------------------------
    let total;

    function loadCheckoutCart() {
        const cart = JSON.parse(localStorage.getItem('cart')) || [];
        const container = document.getElementById('checkoutCartItems');

        console.log(cart);

        if (!container) return;

        if (cart.length === 0) {
            container.innerHTML = '<p class="empty-cart-message">Your cart is empty</p>';
            return;
        }

        container.innerHTML = cart.map(item => `
            <div class="checkout-cart-item">
                <img src="${item.image}" alt="${item.name}">
                <div class="checkout-item-info">
                    <div class="checkout-item-name">${item.name}</div>
                    <div class="checkout-item-quantity">Qty: ${item.quantity}</div>
                    <div class="checkout-item-price">â‚±${item.price * item.quantity}</div>
                </div>
            </div>
        `).join('');

        total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        document.getElementById('basketPrice').textContent = `â‚±${total}`;
        document.getElementById('orderTotal').textContent = `â‚±${total + 50}`;
    }

    loadCheckoutCart();
    window.addEventListener('load', loadCheckoutCart);

    // -------------------------------
    // Multi-step Checkout
    // -------------------------------
    let currentStep = 1;

    function showStep(step) {
        const personalForm = document.getElementById('personalInfoForm');
        const paymentForm = document.getElementById('paymentForm');

        personalForm.classList.toggle('active', step === 1);
        paymentForm.classList.toggle('active', step === 2);

        document.querySelectorAll('.step').forEach((s, index) => {
            s.classList.toggle('active', index + 1 === step);
        });

        currentStep = step;
    }

    // -------------------------------
    // Submit Order to Backend
    // -------------------------------
    async function submitOrderToBackend(paymentMethod) {
        const cart = JSON.parse(localStorage.getItem('cart')) || [];
        
        if (cart.length === 0) {
            alert('Your cart is empty!');
            return null;
        }

        // Prepare order data matching your OrderDto structure
        const orderData = {
            items: cart.map(item => ({
                name: item.name,
                price: item.price,
                quantity: item.quantity
            })),
            deliveryFee: 50,
            paymentMethod: paymentMethod
        };

        try {
            const response = await fetch('/Home/SubmitOrder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(orderData)
            });

            if (!response.ok) {
                throw new Error('Failed to submit order');
            }

            const result = await response.json();
            console.log('Order submitted:', result);
            
            // Store payment method for receipt page
            localStorage.setItem('paymentMethod', paymentMethod);
            
            return result.orderId; // Returns the order number
            
        } catch (error) {
            console.error('Error submitting order:', error);
            alert('Failed to submit order. Please try again.');
            return null;
        }
    }

    // -------------------------------
    // Next button logic
    // -------------------------------
    window.goNext = async function () {
        if (currentStep === 1) {
            // Validate personal info
            const fullName = document.getElementById('fullName').value;
            const email = document.getElementById('email').value;
            const streetAddress = document.getElementById('streetAddress').value;
            const city = document.getElementById('city').value;
            const phoneNumber = document.getElementById('phoneNumber').value;

            if (!fullName || !email || !streetAddress || !city || !phoneNumber) {
                alert('Please fill in all required fields');
                return;
            }

            // Save customer info to localStorage
            localStorage.setItem('customerInfo', JSON.stringify({
                fullName,
                email,
                streetAddress,
                city,
                phoneNumber
            }));

            showStep(2);
            
        } else if (currentStep === 2) {
            const selectedPayment = document.querySelector('input[name="paymentMethod"]:checked');

            if (!selectedPayment) {
                alert('Please select a payment method');
                return;
            }

            const paymentMethod = selectedPayment.value;
            const orderTotal = total + 50;

            // Show loading state
            const nextBtn = document.getElementById('nextBtn');
            const originalText = nextBtn.innerHTML;
            nextBtn.disabled = true;
            nextBtn.innerHTML = 'Processing...';

            // Submit order to backend
            const orderId = await submitOrderToBackend(paymentMethod);

            if (!orderId) {
                // Restore button if failed
                nextBtn.disabled = false;
                nextBtn.innerHTML = originalText;
                return;
            }

            // Redirect based on payment method
            switch (paymentMethod) {
                case 'maya':
                    window.location.href = `/PayMaya/PayMayaMain?amount=${orderTotal}&orderId=${orderId}`;
                    break;
                case 'gcash':
                    window.location.href = `/GCash/GcashMain?amount=${orderTotal}&orderId=${orderId}`;
                    break;
                case 'cod':
                    // Go directly to receipt for COD
                    window.location.href = `/Home/Receipt?orderNumber=${orderId}`;
                    break;
                default:
                    alert('Payment option not implemented');
                    nextBtn.disabled = false;
                    nextBtn.innerHTML = originalText;
            }
        }
    };

    // Back button
    window.goBack = function () {
        if (currentStep > 1) showStep(currentStep - 1);
    };
});


// MOVE MO TO 
/*const cartDataJson = {
    name: cart.name
}/*

/*function sendCartData() {
    fetch("/Home/sendCartData", {
        method: "POST",
        headers: {
            "Content-Type": "application"
        },
        body: 
    });
}*/

</script>

    <script src="~/js/site.js"></script>
</body>
</html>