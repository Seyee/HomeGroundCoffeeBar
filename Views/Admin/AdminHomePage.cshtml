@model List<Models.UserModel>

<div class="content">
    <table id="users-table">
        <thead>
            <tr>
                <th>Id</th>
                <th>Name</th>
                <th>Password</th>
                <th>Phone Number</th>
                <th>Role</th>
                <th>Operator</th>
            </tr>
        </thead>
        <tbody>
            @if (Model != null && Model.Count > 0)
            {
                @foreach (var user in Model)
                {
                    <tr data-id="@user.Id">
                        <td class="id">#@user.Id</td>
                        <td class="name">@user.Name</td>
                        <td class="password">@user.Password</td>
                        <td class="phone">@user.Phone</td>
                        <td class="role" data-original="@user.Role">@user.Role</td>
                        <td>
                            <button class="edit-btn">Edit</button>
                            <button class="save-btn" style="display:none;">Save</button>
                            <button class="cancel-btn" style="display:none;">Cancel</button>
                            <button class="delete-btn">Delete</button>
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="6">No users found.</td>
                </tr>
            }
        </tbody>
    </table>
</div>

<style>
* { margin:0; padding:0; box-sizing:border-box; font-family: 'Poppins', sans-serif; }
body { background-color:#2A241E; color:#fff; min-height:100vh; }
.content { padding:20px; }
table { width:100%; border-collapse: collapse; background-color:#2A241E1e; color:#fff; }
th, td { padding:12px; text-align:left; border-bottom:1px solid #333; }
button { padding:4px 10px; cursor:pointer; border:none; border-radius:4px; margin-right:4px; }
.edit-btn { background-color:#6A5C50; color:#fff; }
.save-btn { background-color:#CCBEA8; color:#2A241E; }
.cancel-btn { background-color:#FF6B6B; color:#fff; }
.delete-btn { background-color:#E63946; color:#fff; }
td[contenteditable="true"] { background-color:#3A322B; }
select { background-color:#3A322B; color:#CCBEA8; border:none; border-radius:4px; padding:2px; }
</style>

<script>
document.querySelectorAll('tr[data-id]').forEach(row => {
    const editBtn = row.querySelector('.edit-btn');
    const saveBtn = row.querySelector('.save-btn');
    const cancelBtn = row.querySelector('.cancel-btn');
    const deleteBtn = row.querySelector('.delete-btn');

    // EDIT
    editBtn?.addEventListener('click', () => {
        // Hide Delete, show Save & Cancel
        deleteBtn.style.display = 'none';
        saveBtn.style.display = 'inline';
        cancelBtn.style.display = 'inline';
        editBtn.style.display = 'none';

        // Make editable
        row.querySelectorAll('td.name, td.password, td.phone').forEach(td => {
            td.dataset.original = td.textContent.trim();
            td.setAttribute('contenteditable', 'true');
            td.style.backgroundColor = '#3A322B';
        });

        // Role dropdown
        const roleCell = row.querySelector('td.role');
        const currentRole = roleCell.textContent.trim();
        roleCell.dataset.original = currentRole;
        const select = document.createElement('select');
        ['Admin', 'User'].forEach(r => {
            const option = document.createElement('option');
            option.value = r;
            option.textContent = r;
            if (r === currentRole) option.selected = true;
            select.appendChild(option);
        });
        roleCell.innerHTML = '';
        roleCell.appendChild(select);
    });

    // CANCEL
    cancelBtn?.addEventListener('click', () => {
        if(confirm('Are you sure you want to cancel editing?')) {
            row.querySelectorAll('td.name, td.password, td.phone').forEach(td => {
                td.textContent = td.dataset.original;
                td.removeAttribute('contenteditable');
                td.style.backgroundColor = 'transparent';
            });

            const roleCell = row.querySelector('td.role');
            roleCell.textContent = roleCell.dataset.original;

            // Toggle buttons
            editBtn.style.display = 'inline';
            deleteBtn.style.display = 'inline';
            saveBtn.style.display = 'none';
            cancelBtn.style.display = 'none';
        }
    });

    // SAVE
    saveBtn?.addEventListener('click', async () => {
        const user = {
            Id: row.dataset.id,
            Name: row.querySelector('td.name').innerText.trim(),
            Password: row.querySelector('td.password').innerText.trim(),
            Phone: row.querySelector('td.phone').innerText.trim(),
            Role: row.querySelector('td.role select').value
        };

        try {
            const res = await fetch('/Admin/EditUser', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(user)
            });

            if(res.ok){
                alert('User updated successfully!');
                
                // Update table cells
                row.querySelectorAll('td.name, td.password, td.phone').forEach(td => {
                    td.dataset.original = td.textContent;
                    td.removeAttribute('contenteditable');
                    td.style.backgroundColor = 'transparent';
                });
                
                const roleCell = row.querySelector('td.role');
                roleCell.dataset.original = user.Role;
                roleCell.textContent = user.Role;

                // Toggle buttons
                editBtn.style.display = 'inline';
                deleteBtn.style.display = 'inline';
                saveBtn.style.display = 'none';
                cancelBtn.style.display = 'none';

            } else {
                const data = await res.json();
                alert(data?.message || 'Error updating user.');
            }
        } catch (err) {
            alert('Server error!');
        }
    });

    // DELETE
    deleteBtn?.addEventListener('click', async () => {
        if(confirm('Are you sure you want to delete this user?')) {
            try {
                const res = await fetch('/Admin/DeleteUser', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ Id: row.dataset.id })
                });

                if(res.ok){
                    alert('User deleted successfully!');
                    row.remove();
                } else {
                    const data = await res.json();
                    alert(data?.message || 'Error deleting user.');
                }
            } catch(err){
                alert('Server error!');
            }
        }
    });
});
</script>
